---
title: "Untitled"
output: html_document
date: "2022-11-13"
---

```{r}
library(dplyr, warn.conflicts = FALSE)
library(tidygeocoder)
library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.extras)
library(leaflet.extras2)
library(RColorBrewer)
library(htmltools)
library(ggplot2)
library(DT)
library(glue)
library(plotly)
library(viridis)
library(mapproj)
library(pals)
library(colourvalues)
library(paletteer)
```
```{r}
# import Nashville airbnb list from insideairbnb.com
airbnb <- read_csv("airbnb.csv")
airbnb
```

```{r}
# gets addresses based on GPS coordinates. Not necessary, just wanted to see how accurate the detection was.
#addys <- airbnb %>%
  #reverse_geocode(lat = latitude, long = longitude, method = 'arcgis',
                  #address = address_found, full_results = FALSE)

```

```{r}
#write.csv(addys, "airbnb.csv", row.names=FALSE)
```

```{r}
# Davidson county border
nash <- st_read("Davidson.geojson")
```

```{r}
# clean coordinates for Google Street View links
airbnb$coord<-paste(airbnb$latitude,airbnb$longitude,sep=",")
airbnb
```

```{r}
# fill Google Street View links with coordinates to properties
airbnb$links <- glue("http://maps.google.com/maps?q=&layer=c&cbll={airbnb$coord}")
airbnb
```

```{r}
# make Google Street View links clickable
content <- airbnb %>% 
    mutate(popup = paste0('<a href =', links, 'target=_blank>', address_found, '</a>'))
```


```{r}
# more airbnb data with website links
list_urls <- read_csv("listings-2.csv")
list_urls
```

```{r}
merged <- merge(x = content, y = list_urls[ , c("id", "listing_url")], by = "id", all.x=TRUE)
merged
```


```{r}
merged <- merge(x = merged, y = list_urls[ , c("id", "picture_url")], by = "id", all.x=TRUE)
merged
```


```{r}
# tallies room by type
table(list_urls$room_type)
```


```{r}
pal <- colorFactor(
  palette = 'Dark2',
  domain = list_urls$room_type
)
```

```{r}
# link properties to Airbnb website listing
total <- merged %>% 
    mutate(popup2 = paste0('<a target=_blank href =', listing_url, '>', name, '</a>'))
total
```

```{r}
total <- total %>% 
    mutate(popup = paste0('<a target=_blank href =', links, '>', address_found, '</a>'))
```

```{r}
# Places picture of property in popup
total <- total %>% 
    mutate(popup3 = paste0("<img src='",picture_url,"' width='200px' height='100px'>"))
```

```{r}
# clean addresses
total$address_found <- gsub(",", "", total$address_found)
total
```

```{r}
total$address_found <- gsub("USA", "", total$address_found)
total
```

```{r}
# Assign airbnb categories to their own group
home <- total %>% 
  filter(room_type=="Entire home/apt")
hotel <- total %>% 
  filter(room_type=="Hotel room")
private <- total %>% 
  filter(room_type=="Private room")
shared <- total %>% 
  filter(room_type=="Shared room")
```

```{r}
# Nashville districts
districts <- read_csv("districts.csv")
districts
```

```{r}
# Nashville districts geojson file
district_json <- st_read("districts.geojson")
```
```{r}
# define variables for mapping
bins <- c(20, 50, 100, 250, 500, 750, 1000, 1800)
pal2 <- colorBin("PuRd", domain = total$neighbourhood, bins = bins)
```

```{r}
table(total$neighbourhood)
```
```{r}
# creates a tibble tally of total airbnb's by district
d <- total %>% 
  group_by(neighbourhood) %>% 
  tally()
```
```{r}
d$neighbourhood <- gsub("District", "", d$neighbourhood) 
```
```{r}
d$neighbourhood <- as.numeric(d$neighbourhood)
```
```{r}
district_tally <- merge(districts, d, by.x = "District", by.y = "neighbourhood")
district_tally
```

```{r}
# Choropleth map of airbnbs by district
leaflet(options = leafletOptions(minZoom = 10, preferCanvas = TRUE))  %>% 
    addProviderTiles("Stamen.TonerHybrid")  %>% 
    addPolygons(data = district_json, 
                weight = 2, 
                color ="white", 
                opacity=1, 
                fillColor = pal2(district_tally$n),
                dashArray = "3", 
                highlightOptions = highlightOptions(
                                  weight = 5,
                                  color = "#666",
                                  dashArray = "",
                                  fillOpacity = 0.7,
                                  bringToFront = TRUE),
                popup = total$neighbourhood) %>%
    setView(lat = 36.1627, lng = -86.7816, zoom = 11)
```


```{r}
# map of airbnb properties
nash %>% 
leaflet(options = leafletOptions(minZoom = 10, preferCanvas = TRUE))  %>% 
    addProviderTiles("CartoDB.Positron")  %>% 
    addPolygons(data=district_json, color ="grey", opacity=1) %>%
    addCircleMarkers(data = total, radius = 2 , weight = 0.5, label = ~name,
                     popup = paste("<h3>Airbnb</h3>", total$popup3, "<br>", "Name:", 
                     total$popup2,"<br>" ,total$popup),
                     color= ~pal(room_type), group = "name") %>%
    addLegend(position ="topright", pal = pal, values = total$room_type) %>%
    addSearchFeatures(
      targetGroups ="name", options = searchFeaturesOptions(zoom =12,
      openPopup = TRUE, firstTipSubmit = TRUE,
      autoCollapse = FALSE, hideMarkerOnCollapse = TRUE)) %>%
    setView(lat = 36.1627, lng = -86.7816, zoom = 11) %>%
    addLayersControl(overlayGroups =c("home", "hotel", "private", "shared"))  
```
```{r}
#crime <- read_csv("crimef.csv")
```

```{r}
# convert airbnb dataframe to sf object
ab_sf <- st_as_sf(total, coords =c("longitude","latitude"), crs =4326)
```


```{r}
# convert crime dataframe to sf object
#crime_sf <- st_as_sf(crime, coords =c("Longitude","Latitude"), crs =4326)
```


```{r}
# read in crime data
crimes <- read_csv("crimes.csv")
```
```{r}
# remove duplicates
crimes <- distinct(crimes)
```


```{r}
#crimes <- crimes[!duplicated(crimes), ]
```


```{r}
#half_mile <- st_is_within_distance(ab_sf, crime_sf, dist = 804.672)
```

```{r}
# testing for loop of sgbp list
#indices <- c(1:10)
```

```{r}
#for(i in 1:length(indices)) {  
  #print(crime_sf[half_mile[[i]], c(5,6,9)])}
```


```{r}
#nrow(crime_sf[half_mile[[88]], c(5,6,9)]) 
```



```{r}
#colnames(crime_sf)[9] = "offense"
```



```{r}
# ggplot(crime_sf[half_mile[[47]], c(5,6,9)], aes(x=2, y=nrow(crime_sf[half_mile[[47]], c(5,6,9)]), fill=offense)) + 
#   geom_bar(stat="identity", color="white") + 
#   coord_polar("y", start=0) +
#   theme_void() +
#   scale_fill_brewer(palette="Dark2") +
#   ggtitle(paste(nrow(crime_sf[half_mile[[47]], c(5,6,9)]), "incidents")) +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   xlim(c(0.5, 2.5))
```


```{r}
#ab_sf$indicator <- st_is_within_distance(ab_sf, crime_sf, dist = 804.672) 
```



```{r}
# closer to final map for Shiny app
nash %>% 
leaflet(options = leafletOptions(minZoom = 10, preferCanvas = TRUE))  %>% 
    addProviderTiles("CartoDB.Positron")  %>% 
    addCircleMarkers(data = total, radius = 2 , weight = 1, label = ~name,
                     popup = paste("<h3>Airbnb</h3>", total$popup3, "<br>", "Name:", 
                     total$popup2,"<br>" ,total$popup),
                     color= ~pal(room_type), group = "name") %>%
    addSearchFeatures(
      targetGroups ="name", options = searchFeaturesOptions(zoom =12,
      openPopup = TRUE, firstTipSubmit = TRUE,
      autoCollapse = FALSE, hideMarkerOnCollapse = TRUE)) %>%
    addCircleMarkers(data = crimes, radius = 3, weight=3, color="red", label = paste(crimes$Offense_Description, "<br>Date:", crimes$Incident_Occurred) %>% lapply(htmltools::HTML),
                      clusterOptions = markerClusterOptions(spiderfyDistanceMultiplier=1.5)) %>% 
    addLegend(position ="topright", pal = pal, values = total$room_type) %>%
    setView(lat = 36.1627, lng = -86.7816, zoom = 11) %>%
    addLayersControl(overlayGroups =c("home", "hotel", "private", "shared")) %>%
    addMeasure(
          position = "bottomleft",
          primaryLengthUnit = "meters",
          primaryAreaUnit = "sqmeters",
          activeColor = "#0bd3d3",
          completedColor = "#f890e7"
        ) %>% 
    addResetMapButton()
```
```{r}
# remove missing coordinates
crimes <- crimes[!is.na(crimes$Latitude),]
```

```{r}
# general cleaning of categories
crimes$Offense_Description <- gsub("BURGLARY- MOTOR VEHICLE", "BURGLARY - MOTOR VEHICLE", crimes$Offense_Description) #remove () from 
```
```{r}
crimes$Offense_Description <- gsub("BURGLARY- AGGRAVATED", "BURGLARY - AGGRAVATED", crimes$Offense_Description)
```

```{r}
#convert crimes to sf object
crimes_sf <- st_as_sf(crimes, coords =c("Longitude","Latitude"), crs =4326)
```

```{r}
# locates all crimes within a quarter mile distance of airbnb properties and returns sgbp index list
quarter_mile <- st_is_within_distance(ab_sf, crimes_sf, dist = 402.336)
quarter_mile
```

```{r}
# leaflet() %>%
#   # add a dark basemap
#   addProviderTiles("CartoDB.DarkMatter") %>%
#  
#   # add a heatmap
#   addWebGLHeatmap(
#     data = crimes,
#     size = 2000,
#     units = "m",
#     intensity = 0.1,
#     gradientTexture = "skyline",
#     alphaRange = 1,
#     opacity = 0.8
#     ) %>%
#   # add a measure control to the bottom left
#   addMeasure(
#     position = "bottomleft",
#     primaryLengthUnit = "meters",
#     primaryAreaUnit = "sqmeters",
#     activeColor = "#0bd3d3",
#     completedColor = "#f890e7"
#   ) %>%
#   addMiniMap(tiles="CartoDB.DarkMatter")
```


```{r}
# sorts crimes by category
crime_category <- sort(table(crimes$Offense_Description), decreasing = TRUE)
crime_category <- data.frame(crime_category[crime_category > 100])
colnames(crime_category) <- c("Category", "Frequency")
crime_category$Percentage <- crime_category$Frequency / sum(crime_category$Frequency)
#datatable(df_category, options = list(scrollX='400px'))
crime_category
```

```{r}
total[1,]
```
```{r}
# convert dates for Shiny date range input
crimes$Incident_Occurred <- as.Date(crimes$Incident_Occurred, "%m/%d/%y %H:%M")
```

```{r}
glimpse(crimes$Incident_Occurred)
```
```{r}
# assign unique id to each crime (same as index) for Shiny interactivity
crimes$uid <- seq.int(nrow(crimes))
total$uid <- seq.int(nrow(total))
```

```{r}
date_filter <- crimes
```

```{r}
# assign unique id to each airbnb (same as index) for Shiny interactivity
total$id <- seq.int(nrow(total))
```

```{r}
colnames(crimes_sf)[6] = "offense"
```


```{r}
# experimenting with plot summary of crimes within certain distance of airbnb properties. Want to have this visible in Shiny upon click of property
ggplot(crimes_sf[quarter_mile[[47]], c(3,4,6)], aes(x=2, y=nrow(crimes_sf[quarter_mile[[47]], c(3,4,6)]), fill=offense)) + 
  geom_bar(stat="identity", color="white") + 
  coord_polar("y", start=0) +
  theme_void() +
  scale_fill_brewer(palette="Dark2") +
  ggtitle(paste(nrow(crimes_sf[quarter_mile[[47]], c(3,4,6)]), "incidents")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlim(c(0.5, 2.5))
```


```{r}
max(lengths(quarter_mile))
```

```{r}
#virid <- brewer.pal(n = 11, name = "Spectral")
```

```{r}
virid <- paletteer_d("rcartocolor::Antique", n = 12)
```


```{r}
crimes_sf[quarter_mile[[150]], 6] %>%
      group_by(offense) %>%
      summarize(count = n()) %>%
      plot_ly(labels = ~offense, 
              values= ~count, 
              marker = list(colors = virid,
                            line = list(color = '#FFFFFF', 
                                        width = 1))) %>%
      add_pie(hole = 0.6) %>%
      layout(title = paste(nrow(crimes_sf[quarter_mile[[150]], 6]),"crimes"),  showlegend = F,
             xaxis = list(showgrid = F, zeroline = F, showticklabels = F),
             yaxis = list(showgrid = F, zeroline = F, showticklabels = F))
```

```{r}
# Additional layers for map
crime_number <- sapply(quarter_mile, length)
crime_column <- as.data.frame(crime_number)
crime_column$uid <- seq.int(nrow(crime_column))
```

```{r}
total = merge(total, crime_column, by.x="uid")
```

```{r}
total <- total %>% 
       mutate(group = case_when(crime_number>=1 & crime_number<=10 ~ "Extremely Low Crime",
                                 crime_number>=11  & crime_number<=50 ~ "Low Crime",
                                crime_number>=51  & crime_number<=150 ~ "Average Crime",
                                 crime_number>=151  & crime_number<=400 ~ "High Crime",
                                crime_number>=401 ~ "Extremely High Crime",
                                TRUE ~ "No Crime"))
```

```{r}
no_crime <- total %>% 
  filter(group=="No Crime")
el_crime <- total %>% 
  filter(group=="Extremely Low Crime")
l_crime <- total %>% 
  filter(group=="Low Crime")
ave_crime <- total %>% 
  filter(group=="Average Crime")
high_crime <- total %>% 
  filter(group=="High Crime")
eh_crime <- total %>% 
  filter(group=="Extremely High Crime")
```




